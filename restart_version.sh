#!/bin/bash

# Функция для отображения ASCII-арт заголовка

show_header() {
    echo -e "\033[97m# =------------------------------------==============+===---------------------------------------------\033[0m"
    echo -e "\033[97m# -----------------------------------=====--------------====------------------------------------------\033[0m"
    echo -e "\033[97m# --------------------------------=====--------------------===----=====-------------------------------\033[0m"
    echo -e "\033[97m# -------------------------------====--------=+**=-----------==--=----===-----------------------------\033[0m"
    echo -e "\033[97m# ------------------------------===---------+*###*------------==========-----------------=+=----------\033[0m"
    echo -e "\033[97m# -----------------------------===----------*##*+---------------==----------=====---==-=++==**--------\033[0m"
    echo -e "\033[97m# ----------------------------===--------------------------------=-------==-------+++**=-+#*++*=------\033[0m"
    echo -e "\033[97m# ----------------------------===-----=*+------------------------==---===-------+#*-:-+#+--*#====-----\033[0m"
    echo -e "\033[97m# ----------------------------===------+#+=----------------------==-===--------*##*+:::+#=--**:--=----\033[0m"
    echo -e "\033[97m# -----------=============----==--------+#*=-------=**##+--------====---------*####*=:::+#=-+=:::-==--\033[0m"
    echo -e "\033[97m# -------===---------------======--------=*#=-----=*####=--------===--------:+*#####*-:::+#=-:::::-=--\033[0m"
    echo -e "\033[97m# -----==--:::::::::::-------====---------=*#+-----=++=----------==----------*#######*-:::*#-::::::-=-\033[0m"
    echo -e "\033[97m# ---==--:::::::---:::--------===-----------*#*-----------------===----------*########+:::-**-=+=:::-=\033[0m"
    echo -e "\033[97m# --=--:::::::-*##**=----------===-----------+#*----------------==----------:+*########=:::-#+-=*+-=+=\033[0m"
    echo -e "\033[97m# -=-::::::::::=*###*----+*#+---===----------------------------=+=------------*########*=:::=#=-=#=-*= \033[0m"
    echo -e "\033[97m# =-:::::::::::::-------*###-----===--------------------------====-------------*########*-::-**-=*=-*= \033[0m"
    echo -e "\033[97m# =-:::::::::::::::----+###+-------===----------------------=======-------------+########*-::=#==*-=+=\033[0m"
    echo -e "\033[97m# -=-::::::::::::::::---=####---------=====----------------=====--===---------------=*######*--=#=--:-\033[0m"
    echo -e "\033[97m# -=-:::::::::::-::-:---+##%=----------=========------========-----===-----------------=+**#**+=-:::-=\033[0m"
    echo -e "\033[97m# -=-::::::::=*###**=---+##%-----------=--=================--------=+==-------------------::::::::--==-\033[0m"
    echo -e "\033[97m# -=-::::::::-*####+---*##%-----------==--============--------------=+==-------------------::::::--==--\033[0m"
    echo -e "\033[97m# =-::::::::::------=*#%+----------=====---------------------------==+==-----------------------==-----\033[0m"
    echo -e "\033[97m# =--:::::::::::----=*##------====----------------------------------======-------------------==-----=-\033[0m"
    echo -e "\033[97m# -=--::::::::::-----=#=---===----------==========------------------==--======------------====-------\033[0m"
    echo -e "\033[97m# --==--::::::::--------===----=========-=========------------============-----========----::==------\033[0m"
    echo -e "\033[97m# ----=----::::------===----=========-----==================----------------====------------:-==------\033[0m"
    echo -e "\033[97m# ------=----------==-----=======---======--------===-----------------------------------=+=-:-==-----\033[0m"
    echo -e "\033[97m# =-------===-----==-========---====---------===-----------------===-----------------======-:-==-----\033[0m"
    echo -e "\033[97m# -----------=-============--===------------=----------==========---==--=====--------=---+---:==-----\033[0m"
    echo -e "\033[97m# -----------=-:---======---=----------======----=---====--=====----==----------------=+=----:-=-----\033[0m"
    echo -e "\033[97m# -----------=-:-----===-----------=====----==--=====---------------==-------------------------=-----\033[0m"
    echo -e "\033[97m# -----------=-:-----------------==----==----=====------------------==-------------------------=---=-\033[0m"
    echo -e "\033[97m# -----------==::-----------------------==----====------------------==-------------------------=-----\033[0m"
    echo -e "\033[97m# -----------==-:-----------------------==-----===------------------==-------------------------=-----\033[0m"
    echo -e "\033[97m# ------------=-:------------------------=-----====------------------=------------------------==-=-=-\033[0m"
    echo -e "\033[97m# ------------==-------------------------==-----===------------------==-----------------------==-----\033[0m"
    echo -e "\033[97m# -------------=-:------------------------=-----===------------------==-----------------------===---=-\033[0m"
    echo -e "\033[97m# --------------=-------------------------==-----===-----------------==-----------------------=------\033[0m"
    echo -e "\033[97m# --------------==-------------------------============--------------==----------------------==-----=-\033[0m"
    echo -e "\033[97m# ---------------=----------------------====-------------------------==----------------------==----=-=\033[0m"
    echo -e "\033[97m# ----------------=------------------===-----===---------------------==---------------------==-------\033[0m"
    echo -e "\033[97m# -----------------=----------------==----============--------------===---------------------==-------\033[0m"
    echo -e "\033[97m# -----------------==--------------==---===--==----====================--------------------==--------\033[0m"
    echo -e "\033[97m# ------------------==-------------=----==----=--===-----===-----------====----------------===-------\033[0m"
    echo -e "\033[97m# -------------------==------------==---==---===-------=-----------------------------------==--=-----\033[0m"
    echo -e "\033[97m# ---------------------=-----------===--=====--------==-----=======-----------------------==-=-=-----\033[0m"
    echo -e "\033[97m# ----------------------=-----------===-==--------=====----==----=======-----------------===---------\033[0m"
    echo -e "\033[97m# -----------------------==-----========-==-----===--=----====---==-=======-------------==-----------\033[0m"
    echo -e "\033[97m# ------------------------==--=========---==---===---==---==-==--------=====-------====-=--==--------\033[0m"
    echo -e "\033[97m# -------------------------==---=======---==-=====---==---==-==-------==----======-----==---==-------\033[0m"
    echo -e "\033[97m# --------------------------===---------===---------===---==-==-----=======--===-------==--===-------\033[0m"
    echo -e "\033[97m# ----------------------------===------===---==---===--==--=--==---===--------------------=-----------\033[0m"
    echo -e "\033[97m# ------------------------------===----===---===-----====-------==----------------------------=------\033[0m"
    echo -e "\033[97m# --------------------------------===--===----=---===--------===--------------------------=-====---\033[0m"
    echo -e "\033[97m# -----------------------------------===------===------==-----=------------------------------------\033[0m"
    echo -e "\033[97m# ===================================----------===--------==------------------------------------\033[0m"
}

show_header


# Установка версии образа для первого и второго обновления
VERSION_1="1.2.0"
VERSION_2="1.3.1"
# Путь к файлу settings.txt
SETTINGS_FILE="./settings.txt"

# Функция для перезагрузки контейнеров
restart_containers() {
  echo "Перезагрузка контейнеров..."
  # Читаем контейнеры из settings.txt
  CONTAINERS=$(grep "^containers=" "$SETTINGS_FILE" | cut -d'=' -f2)

  # Перебираем каждый контейнер и перезагружаем его
  IFS=',' # Устанавливаем разделитель для цикла
  for CONTAINER in $CONTAINERS; do
    echo "Перезагрузка контейнера: $CONTAINER"
    docker restart "$CONTAINER"  # Перезагружаем контейнер
  done
}

# Путь к файлу docker-compose.yaml
COMPOSE_FILE="/root/infernet-container-starter/deploy/docker-compose.yaml"

# Функция для обновления версии образа и перезагрузки контейнеров
update_and_restart() {
  local version=$1
  echo "Обновление версии образа на ${version}..."
  sed -i "s|\(image: ritualnetwork/infernet-node:\).*|\1${version}|" "$COMPOSE_FILE"
  
  echo "Перезапуск контейнеров с версией ${version}..."
  docker compose -f "$COMPOSE_FILE" down
  docker compose -f "$COMPOSE_FILE" up -d
  echo "Контейнеры успешно запущены с версией ${version}."
}

# Проверка существования файла
echo "Проверка наличия файла: $COMPOSE_FILE"
if [[ -f "$COMPOSE_FILE" ]]; then
  # Обновление и перезагрузка для версии 1.2.0
  update_and_restart "$VERSION_1"
  restart_containers

  # Обновление и перезагрузка для версии 1.3.1
  update_and_restart "$VERSION_2"
  restart_containers
else
  echo "Файл $COMPOSE_FILE не найден."
fi
